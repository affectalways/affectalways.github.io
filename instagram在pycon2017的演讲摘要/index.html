<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Instagram在PyCon2017的演讲摘要 - </title><meta name="Description" content="python，Instagram在PyCon2017的演讲摘要"><meta property="og:title" content="Instagram在PyCon2017的演讲摘要" />
<meta property="og:description" content="python，Instagram在PyCon2017的演讲摘要" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://affectalways.github.io/instagram%E5%9C%A8pycon2017%E7%9A%84%E6%BC%94%E8%AE%B2%E6%91%98%E8%A6%81/" />
<meta property="og:image" content="https://github.com/affectalways/affectalways.github.io/blob/master/icons/3a.png?raw=true"/>
<meta property="article:published_time" content="2020-07-21T22:38:37+08:00" />
<meta property="article:modified_time" content="2020-07-21T22:38:37+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://github.com/affectalways/affectalways.github.io/blob/master/icons/3a.png?raw=true"/>

<meta name="twitter:title" content="Instagram在PyCon2017的演讲摘要"/>
<meta name="twitter:description" content="python，Instagram在PyCon2017的演讲摘要"/>
<meta name="application-name" content="affectalways">
<meta name="apple-mobile-web-app-title" content="affectalways"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://affectalways.github.io/instagram%E5%9C%A8pycon2017%E7%9A%84%E6%BC%94%E8%AE%B2%E6%91%98%E8%A6%81/" /><link rel="prev" href="https://affectalways.github.io/offer18-%E5%88%A0%E9%99%A4%E9%93%BE%E8%A1%A8%E7%9A%84%E8%8A%82%E7%82%B9/" /><link rel="next" href="https://affectalways.github.io/141%E7%8E%AF%E5%BD%A2%E9%93%BE%E8%A1%A8/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Instagram在PyCon2017的演讲摘要",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/affectalways.github.io\/instagram%E5%9C%A8pycon2017%E7%9A%84%E6%BC%94%E8%AE%B2%E6%91%98%E8%A6%81\/"
        },"image": ["https:\/\/raw.githubusercontent.com\/affectalways\/affectalways.github.io\/master\/favicon.ico"],"genre": "posts","keywords": "python","wordcount":  6098 ,
        "url": "https:\/\/affectalways.github.io\/instagram%E5%9C%A8pycon2017%E7%9A%84%E6%BC%94%E8%AE%B2%E6%91%98%E8%A6%81\/","datePublished": "2020-07-21T22:38:37+08:00","dateModified": "2020-07-21T22:38:37+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "affectalways","logo": "https:\/\/raw.githubusercontent.com\/affectalways\/affectalways.github.io\/master\/favicon.ico"},"author": {
                "@type": "Person",
                "name": "affectalways"
            },"description": "python，Instagram在PyCon2017的演讲摘要"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title=""><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico"
        data-srcset="https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico, https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico 1.5x, https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico"
        title="https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico" /><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/affectalways/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title=""><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico"
        data-srcset="https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico, https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico 1.5x, https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico"
        title="https://raw.githubusercontent.com/affectalways/affectalways.github.io/master/favicon.ico" /><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/affectalways/" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Instagram在PyCon2017的演讲摘要</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>affectalways</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/python/"><i class="far fa-folder fa-fw"></i>python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-07-21">2020-07-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6098 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;<span id="/instagram%E5%9C%A8pycon2017%E7%9A%84%E6%BC%94%E8%AE%B2%E6%91%98%E8%A6%81/" class="leancloud_visitors" data-flag-title="Instagram在PyCon2017的演讲摘要">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#pycon-简介">PyCon 简介</a></li>
    <li><a href="#instagram-简介">Instagram 简介</a></li>
    <li><a href="#python-instagram">Python @Instagram</a>
      <ul>
        <li><a href="#为什么选择-python-和-django">为什么选择 Python 和 Django</a></li>
        <li><a href="#python-语言的优势所在">Python 语言的优势所在</a></li>
        <li><a href="#如何提升运行效率">如何提升运行效率</a></li>
        <li><a href="#升级到-python-3">升级到 Python 3</a></li>
      </ul>
    </li>
    <li><a href="#instagram-升级到-python-3-的故事">Instagram 升级到 Python 3 的故事</a>
      <ul>
        <li><a href="#为什么要升级到-python-3">为什么要升级到 Python 3</a>
          <ul>
            <li><a href="#1-新特性类型注解-type-annotations">1. 新特性：类型注解 Type Annotations</a></li>
            <li><a href="#2-性能">2. 性能</a></li>
            <li><a href="#3-社区">3. 社区</a></li>
          </ul>
        </li>
        <li><a href="#确定迁移方案">确定迁移方案</a>
          <ul>
            <li><a href="#基于主分支的开发流程">基于主分支的开发流程</a></li>
            <li><a href="#被弃用的迁移方案">被弃用的迁移方案</a></li>
          </ul>
        </li>
        <li><a href="#开始迁移工作">开始迁移工作</a></li>
        <li><a href="#使用单元测试来帮助迁移">使用单元测试来帮助迁移</a>
          <ul>
            <li><a href="#单元测试的局限性">单元测试的局限性</a></li>
          </ul>
        </li>
        <li><a href="#迁移过程的技术问题">迁移过程的技术问题</a>
          <ul>
            <li><a href="#unicode-相关的字符串问题">Unicode 相关的字符串问题</a></li>
            <li><a href="#不同-python-版本的-pickle-差异">不同 Python 版本的 pickle 差异</a></li>
            <li><a href="#迭代器">迭代器</a></li>
            <li><a href="#字典的顺序">字典的顺序</a></li>
          </ul>
        </li>
        <li><a href="#迁移到-python-36-后的性能提升">迁移到 Python 3.6 后的性能提升</a></li>
        <li><a href="#结论">结论</a></li>
      </ul>
    </li>
    <li><a href="#instagram-带给我们的启示">Instagram 带给我们的启示</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><strong>郑重声明：本篇文章非原创，摘自<a href="https://www.zlovezl.cn/articles/instagram-pycon-2017/">https://www.zlovezl.cn/articles/instagram-pycon-2017/</a></strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-22-31-37_thumb.jpg"
        data-srcset="http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-22-31-37_thumb.jpg, http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-22-31-37_thumb.jpg 1.5x, http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-22-31-37_thumb.jpg 2x"
        data-sizes="auto"
        alt="http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-22-31-37_thumb.jpg"
        title="图：Instagram Loves Python" /></p>
<h2 id="pycon-简介">PyCon 简介</h2>
<p>PyCon 是全世界最大的以 <a href="https://en.wikipedia.org/wiki/Python_%28programming_language%29" target="_blank" rel="noopener noreffer">Python 编程语言</a> 为主题的技术大会。大会由 Python 社区组织，每年举办一次。在大会上，来自世界各地的 Python 用户与核心开发者齐聚一堂，共同分享 Python 世界的新鲜事、Python 语言的应用案例、使用技巧等等内容。</p>
<h2 id="instagram-简介">Instagram 简介</h2>
<p>Instagram 是一款移动端的照片与视频分享软件，由 Kevin Systrom 和 Mike Krieger 在 2010 年创办。Instagram 在发布后开始快速流行。于 2012 年被 Facebook 以 10 亿美元的价格收购。而当时 Instagram 的员工仅有区区 13 名。</p>
<p>如今，<strong>Instagram 的总注册用户达到 30 亿，月活用户超过 7 亿</strong> <em>（作为对比，微信最新披露的月活跃用户为 9.38 亿）</em>。而令人吃惊的是，这么高的访问量背后，竟完全是由以速度慢著称的 Python + Django 支撑。</p>
<p>在 Python 2017 上，Instagram 的工程师们带来了一个有关 Python 在 Instagram 的主题演讲，同时还分享了 Instagram 如何将整个项目运行环境升级到 Python 3 的故事。</p>
<p>本文为该次演讲的内容摘要。</p>
<h2 id="python-instagram">Python @Instagram</h2>
<h3 id="为什么选择-python-和-django">为什么选择 Python 和 Django</h3>
<p>Instagram 选择 Django 的原因很简单，Instagram 的两位创始人 <em>(Kevin Systrom and Mike Krieger)</em> 都是产品经理出身。<strong>在他们想要创造 Instagram 时，Django 是他们所知道的最稳定和成熟的技术之一。</strong></p>
<p>时至今日，即使已经拥有超过 30 亿的注册用户。Instagram 仍然是 Python 和 Django 的重度使用者。Instagram 的工程师 Hui Ding 说到： <em>『一直到用户 ID 已经超过了 32bit int 的限额（约为 20 亿），Django 本身仍然没有成为我们的瓶颈所在。』</em></p>
<p>不过，除了使用 Django 的原生功能外，Instagram 还对 Django 做了很多定制化工作：</p>
<ul>
<li>
<p>扩展 Django Models 使其支持 Sharding <em>（一种数据库分片技术）</em>，<a href="https://engineering.instagram.com/@InstagramEng" target="_blank" rel="noopener noreffer">Instagram Engneering</a> 博客专门为这件事情写过一篇博客，可参阅：<a href="https://engineering.instagram.com/sharding-ids-at-instagram-1cf5a71e5a5c" target="_blank" rel="noopener noreffer">Sharding &amp; IDs at Instagram</a></p>
</li>
<li>
<p>手动关闭 GC（垃圾回收）来提升 Python 内存管理效率，他们同样也写过一篇博客来说明这件事情：<a href="https://engineering.instagram.com/dismissing-python-garbage-collection-at-instagram-4dca40b29172" target="_blank" rel="noopener noreffer">Dismissing Python Garbage Collection at Instagram</a></p>
</li>
<li>
<p>在位于不同地理位置的多个数据中心部署整套系统</p>
</li>
</ul>
<h3 id="python-语言的优势所在">Python 语言的优势所在</h3>
<p>Instagram 的联合创始人 Mike Krieger 说过： <em>『我们的用户根本不关心 Instagram 使用了哪种关系数据库，他们当然也不关心 Instagram 是用什么编程语言开发的。』</em></p>
<p>所以，Python 这种 <strong>简单</strong> 而且 <strong>实用至上</strong> 的编程语言最终赢得了 Instagram 的青睐。他们认为，使用 Python 这种简单的语言有助于塑造 Instagram 的工程师文化，那就是：</p>
<ol>
<li><strong>专注于定位问题、解决问题</strong> - 而不是工具本身的各种花花绿绿的特性</li>
<li><strong>使用那些经过市场验证过的成熟技术方案</strong> - 而不用被工具本身的问题所烦扰</li>
<li><strong>用户至上：专注于用户所能看到的新特性，为用户带去价值</strong></li>
</ol>
<p>但是，即使使用 Python 语言有这么多好处，它还是很慢，不是吗？</p>
<p>不过，这对于 Instagram 不是问题，因为他们认为：<strong>『Instagram 的最大瓶颈在于开发效率，而不是代码的执行效率』</strong></p>
<blockquote>
<p>At Instagram, our bottleneck is development velocity, not pure code execution.</p>
</blockquote>
<p>所以，最终的结论是：<strong>你完全可以使用 Python 语言来实现一个超过几十亿用户使用的产品，而根本不用担心语言或框架本身的性能瓶颈。</strong></p>
<h3 id="如何提升运行效率">如何提升运行效率</h3>
<p>但是，即使是选用了拥有诸多好处的 Python 和 Django。在 Instagram 的用户数迅速增长的过程中，性能问题还是出现了：<strong>服务器数量的增长率已经慢慢的超过了用户增长率</strong>。Instagram 是怎么应对这个问题的呢？</p>
<p>他们使用了这些手段来缓解性能问题：</p>
<ul>
<li><strong>开发工具来帮助调优</strong>：Instagram 开发了很多涵盖各个层面的工具，来帮助他们进行性能调优以及找到性能瓶颈。</li>
<li><strong>使用 C/C++ 来重写部分组件</strong>：把那些稳定而且对性能最敏感的组件，使用 C 或 C++ 来重写，比如访问 memcache 的 library。</li>
<li><strong>使用 Cython</strong>：Cython 也是他们用来提升 Python 效率的法宝之一。</li>
</ul>
<p>除了上面这些手段，他们还在探索异步 IO 以及新的 Python Runtime 所能带来的性能可能性。</p>
<h3 id="升级到-python-3">升级到 Python 3</h3>
<p>在相当长的一段时间，Instagram 都跑在 Python 2.7 + Django 1.3 的组合之上。在这个已经落后社区很多年的环境上，他们的工程师们还打了非常非常多的小 patch。难道他们要被永远卡在这个版本上吗？</p>
<p>所以，在经过一系列的讨论后，他们最终做出一个重大的决定：<strong>升级到 Python 3！！</strong></p>
<p>事实上，Instagram 目前已经完成了将运行环境迁移到 Python 3 的工作 - 他们的整套服务已经在 Python 3 上跑了好几个月了。那么他们是怎么做到的呢？接下来便是由 Instagram 工程师 Lisa guo 带来的 Instagram 如何迁移到 Python 3 的故事。</p>
<h2 id="instagram-升级到-python-3-的故事">Instagram 升级到 Python 3 的故事</h2>
<h3 id="为什么要升级到-python-3">为什么要升级到 Python 3</h3>
<p>对于 Instagram 来说，下面这些因素是推动他们将运行环境迁移到 Python 3 的主要原因：</p>
<h4 id="1-新特性类型注解-type-annotations">1. 新特性：类型注解 Type Annotations</h4>
<p>看看下面这段代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">def compose_from_max_id(max_id):
    &#39;&#39;&#39;@param str max_id&#39;&#39;&#39;
</code></pre></td></tr></table>
</div>
</div><p>图中函数的 <code>max_id</code> 参数究竟是什么类型呢？int？tuple？或是 list? 等等，函数文档里面说它是 str 类型。</p>
<p>但随着时间推移，万一这个参数的类型发生变化了呢？如果某位粗心的工程师修改代码的同时忘了更新文档，那就会给函数的使用者带来很大麻烦，最终还不如没有注释呢。</p>
<h4 id="2-性能">2. 性能</h4>
<p>Instagram 的整个 Django Stack 都跑在 uwsgi 之上，全部使用了同步的网络 IO。这意味着同一个 uwsgi 进程在同一时间只能接收并处理一个请求。这让如何调优每台机器上应该运行的 uwsgi 进程数成了一个麻烦事：</p>
<p><em>为了更好利用 CPU，使用更多的进程数？但那样会消耗大量的内存。而过少的进程数量又会导致 CPU 不能被充分利用。</em></p>
<p>为此，他们决定跳过 Python 2 中哪些蹩脚的异步 IO 实现 <em>（可怜的 gevent、tornado、twisted 众）</em>，直接升级到 Python 3，去探索标准库中的 asyncio 模块所能带来的可能性。</p>
<h4 id="3-社区">3. 社区</h4>
<p>因为 Python 社区已经停止了对 Python 2 的支持。如果把整个运行环境升级到 Python 3，Instagram 的工程师们就能和 Python 社区走的更近，可以更好的把他们的工作回馈给社区。</p>
<h3 id="确定迁移方案">确定迁移方案</h3>
<p>在 Instagram，进行 Python 3 的迁移需要必须满足两个前提条件：</p>
<ol>
<li>不停机，不能有任何的服务因此不可用</li>
<li>不能影响产品新特性的开发</li>
</ol>
<p>但是，在 Instagram 的开发环境中，要满足上面这两点来完成迁移到 Python 3.6 这种庞大的工程是非常困难的。</p>
<h4 id="基于主分支的开发流程">基于主分支的开发流程</h4>
<p>即便使用了以多分支功能著称的 git，Instagram 所有的开发工作都是主要在 master 分支上进行的，Instagram 所奉行的开发哲学是：<strong>『不管是多大的新特性或代码重构，都应该拆解成较小的 Commit 来进行。』</strong></p>
<p>那些被合并进 master 分支的代码，都将在一个小时内被发布到线上环境。**而这样的发布过程每天将会发生上百次。**在这么频繁的发布频率下，如何在满足之前的那两个前提下来完成迁移变得尤其困难。</p>
<h4 id="被弃用的迁移方案">被弃用的迁移方案</h4>
<p><strong>创建一个新分支</strong></p>
<p>很多人在处理这类问题时，第一个蹦进脑子的想法就是： <em>『让我们创建一个分支，当我们开发完后，再把分支合并进来』</em></p>
<p>但在 Instagram 这么高的迭代频率上，使用一个独立分支并不是好主意：</p>
<ol>
<li>Instagram 的 Codebase 每天都在频繁更新，在开发 Python 3 分支的过程中，让新分支与现有 master 分支保持同步开销极大，同时极易出错</li>
<li>最终将 Python 3 分支这个改动非常多的分支合并回 Master 拥有非常高的风险</li>
<li>只有少数几个工程师在 Python 3 分支上专职负责升级工作，其他想帮助迁移工作的工程师无法参与进来</li>
</ol>
<p><strong>挨个替换接口</strong></p>
<p>还有一个方案就是，挨个替换 Instagram 的 API 接口。但是 Instagram 的不同接口共享着很多通用模块。这个方案要实施起来也非常困难。</p>
<p><strong>微服务</strong></p>
<p>还有一个方案就是将 Instagram 改造成微服务架构。通过将那些通用模块重写成 Python 3 版本的微服务来一步步完成迁移工作。</p>
<p>但是这个方案需要重新组织海量的代码。同时，当发生在进程内的函数调用变成 RPC 后 ，整个站点的延迟会变大。此外，更多的微服务也会引入更高的部署复杂度。</p>
<p>所以，既然 Instagram 的开发哲学是：<strong>小步前进，快速迭代</strong>。他们最终决定的方案是：<strong>一步一步来，最终让 master 分支上的代码同时兼容 Python 2 和 Python 3 。</strong></p>
<h3 id="开始迁移工作">开始迁移工作</h3>
<p>既然要让整个 codebase 同时兼容 Python 2 和 Python 3，那么首先要符合这点的就是那些被大量使用的第三方 package。针对第三方 package，Instagram 做到了下面几点：</p>
<ul>
<li>拒绝引入所有不兼容 Python 3 的新 package</li>
<li>去掉所有不再使用的 package</li>
<li>替换那些不兼容 Python 3 的 package</li>
</ul>
<p>在代码的迁移过程中，他们使用了工具 <a href="https://python-modernize.readthedocs.io/en/latest/" target="_blank" rel="noopener noreffer">modernize</a> 来帮助他们。</p>
<p>使用 modernize 时，有一个小技巧：<strong>每次修复多个文件的一个兼容问题，而不是一下修复一个文件中的多个兼容问题。</strong> 这样可以让 Code Review 过程简单很多，因为 Reviewer 每次只需要关注一个问题。</p>
<h3 id="使用单元测试来帮助迁移">使用单元测试来帮助迁移</h3>
<p>对于 Python 这种灵活性极强的动态语言来说，除了真正去执行代码外，几乎没有其他比较好的检查代码错误的手段。</p>
<p>前面提到，Instagram 所有被合并到 master 的代码提交会在一个小时内上线到线上环境，但这不是没有前提条件的。<strong>在上线前，所有的提交都需要通过成千上万个单元测试。</strong></p>
<p>于是，他们开始加入 Python 3 来执行所有的单元测试。一开始，只有极少数的单元测试能够在 Python 3 环境下通过，但随着 Instagram 的工程师们不断的修复那些失败的单元测试，最终所有的单元测试都可以在 Python 3 环境下成功执行。</p>
<h4 id="单元测试的局限性">单元测试的局限性</h4>
<p>但是，单元测试也是有局限性的：</p>
<ul>
<li>Instagram 的单元测试没有做到 100% 的代码覆盖率</li>
<li>很多第三方模块都使用了 mock 技术，而 mock 的行为与真实的线上服务可能会有所不同</li>
</ul>
<p>所以，当所有的单元测试都被修复后，他们开始在线上正式使用 Python 3 来运行服务。</p>
<p>这个过程并不是一蹴而就的。首先，所有的 Instagram 工程师开始访问到这些使用 Python 3 来执行的新服务，然后是 Facebook 的所有雇员，随后是 0.1%、20% 的用户，最终 Python 3 覆盖到了所有的 Instagram 用户。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-29-09-35-43_thumb.jpg"
        data-srcset="http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-29-09-35-43_thumb.jpg, http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-29-09-35-43_thumb.jpg 1.5x, http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-29-09-35-43_thumb.jpg 2x"
        data-sizes="auto"
        alt="http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-29-09-35-43_thumb.jpg"
        title="图：循序渐进的发布流程" /></p>
<h3 id="迁移过程的技术问题">迁移过程的技术问题</h3>
<p>Instagram 在迁移到 Python 3 时碰到很多问题，下面是最典型的几个：</p>
<h4 id="unicode-相关的字符串问题">Unicode 相关的字符串问题</h4>
<p>Python 3 相比 Python 2 最大的改动之一，就是在语言内部对 unicode 的处理。</p>
<p>在 Python 2 中，文本类型 <em>（也就是 unicode）</em> 和二进制类型 <em>（也就是 str）</em> 的边界非常模糊。很多函数的参数既可以是文本，也可以是二进制。但是在 Python 3 中，文本类型和二进制类型的字符串被完全的区分开了。</p>
<p>于是，下面这段在 Python 2 下可以正常运行的代码在 Python 3 下就会报错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">mymac = hmac.new(&#39;abc&#39;)
TypeError: key: expected bytes or bytearray, but got &#39;str&#39;
</code></pre></td></tr></table>
</div>
</div><p>解决办法其实很简单，只要加上判断：如果 value 是文本类型，就将其转换为二进制。如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">value = &#39;abc&#39;
if isinstance(value, six.text_type):
    value = value.encode(encoding=&#39;utf-8&#39;)
mymac = hmac.new(value)
</code></pre></td></tr></table>
</div>
</div><p>但是，在整个代码库中，像上面这样的情况非常多。作为开发人员，如果需要在调用每个函数时都要想想： <em>这里到底是应该编码成二进制，或者是解码成文本呢？</em> 将会是非常大的负担。</p>
<p>于是 Instagram 封装了一些名为 <code>ensure_str()</code>、<code>ensure_binary()</code>、<code>ensure_text()</code> 的帮助函数，开发人员只需对那些不确定类型的字符串，使用这些帮助函数先做一次转换就好。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">mymac = hmac.new(ensure_binary(&#39;abc&#39;))
</code></pre></td></tr></table>
</div>
</div><h4 id="不同-python-版本的-pickle-差异">不同 Python 版本的 pickle 差异</h4>
<p>Instagram 的代码中大量使用了 pickle。比如用它序列化某个对象，然后将其存储在 memcache 中。如下面的代码所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">memcache_data = pickle.dumps(data, pickle.HIGHEST_PROTOCOL)
data = pickle.loads(memcache_data)
</code></pre></td></tr></table>
</div>
</div><p>问题在于，Python 2 与 Python 3 的 pickle 模块是有差别的。</p>
<p>如果上文的第一行代码，刚好是由 Python 3 运行的服务进行序列化后存入 memcache。而反序列化的过程却是由 Python 2 进行，那代码运行时就会出现下面的错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ValueError: unsupported pickle protocol: 4
</code></pre></td></tr></table>
</div>
</div><p>这是由于在 Python 3 中，<code>pickle.HIGHEST_PROTOCOL</code> 的值为 <code>4</code>，而 Python 2 中的的 pickle 最高支持的版本号却是 <code>2</code>。那么如何解决这个问题呢？</p>
<p>Instagram 最终选择让 Python 2 和 Python 3 使用完全不同的 namespace 来访问 memcache。通过将二者的数据读写完全隔开来解决这个问题。</p>
<h4 id="迭代器">迭代器</h4>
<p>在 Python 3 中，很多内置函数被修改成了只返成迭代器 Iterator：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">map()
filter()
dict.items()
</code></pre></td></tr></table>
</div>
</div><p>迭代器有诸多好处，最大的好处就是，使用迭代器不需要一次性分配大量内存，所以它的内存效率比较高。</p>
<p>但是迭代器有一个天然的特点，当你对某个迭代器做了一次迭代，访问完它的内容后，就没法再次访问那些内容了。<strong>迭代器中的所有内容都只能被访问一次。</strong></p>
<p>在 Instagram 的 Python 3 迁移过程中，就因为迭代器的这个特性被坑了一次，看看下面这段代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">CYTHON_SOURCES = [a.pyx, b.pyx, c.pyx]
builds = map(BuildProcess, CYTHON_SOURCES)
while any(not build.done() for build in builds):
    pending = [build for build in builds if not build.started()]
    &lt;do some work&gt;
</code></pre></td></tr></table>
</div>
</div><p>这段代码的用处是挨个编译 Cython 源文件。当他们把运行环境切换到 Python 3 后，一个奇怪的问题出现了：**CYTHON_SOURCES 中的第一个文件永远都被跳过了编译。**为什么呢？</p>
<p>这都是迭代器的锅。在 Python 3 中，<code>map()</code> 函数不再返回整个 list，而是返回一个迭代器。</p>
<p>于是，当第二行代码生成 builds 这个迭代器后，第三行代码的 while 循环迭代了 builds，刚好取出了第一个元素。<strong>于是之后的 pending 对象便里面永远少了那第一个元素。</strong></p>
<p>这个问题解决起来也挺简单的，你只要手动的吧 builds 转换成 list 就可以了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">builds = list(map(BuildProcess, CYTHON_SOURCES))
</code></pre></td></tr></table>
</div>
</div><p>但是这类 bug 非常难定位到。如果用户的 feeds 里面永远少了那最新的第一条，用户很少会注意到。</p>
<h4 id="字典的顺序">字典的顺序</h4>
<p>看看下面这段代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; testdict = {&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: 3}
&gt;&gt;&gt; json.dumps(testdict)
</code></pre></td></tr></table>
</div>
</div><p>它会输出什么结果呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># Python2
&#39;{&#34;a&#34;: 1, &#34;c&#34;: 3, &#34;b&#34;: 2}&#39;
# Python 3.5.1
&#39;{&#34;c&#34;: 3, &#34;b&#34;: 2, &#34;a&#34;: 1}&#39;    # or
&#39;{&#34;c&#34;: 3, &#34;a&#34;: 1, &#34;b&#34;: 2}&#39;
# Python 3.6
&#39;{&#34;a&#34;: 1, &#34;b&#34;: 2, &#34;c&#34;: 3}&#39;
</code></pre></td></tr></table>
</div>
</div><p>在不同的 Python 版本下，这个 json dumps 的结果是完全不一样的。甚至在 3.5.1 中，它会完全随机的返回两个不同的结果。Instagram 有一段判断配置文件是否发生变动的模块，就是因为这个原因出了问题。</p>
<p>这个问题的解决办法是，在调用 <code>json.dumps</code> 传入 <code>sort_keys=True</code> 参数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&gt;&gt;&gt; json.dumps(testdict, sort_keys=True)
&#39;{&#34;a&#34;: 1, &#34;b&#34;: 2, &#34;c&#34;: 3}&#39;
</code></pre></td></tr></table>
</div>
</div><h3 id="迁移到-python-36-后的性能提升">迁移到 Python 3.6 后的性能提升</h3>
<p>当 Instagram 解决了这些奇奇怪怪的版本差异问题后，还有一个巨大的谜题困扰着他们：<strong>性能问题</strong>。</p>
<p>在 Instagram，他们使用两个主要指标来衡量他们的服务性能：</p>
<ul>
<li>每次请求产生的 CPU 指令数（越低越好）</li>
<li>每秒能够处理的请求数（越高越好）</li>
</ul>
<p>所以，当所有的迁移工作完成后，他们非常惊喜的发现：<strong>第一个性能指标，每次请求产生的 CPU 指令数居然足足下降了 12% ！！！</strong></p>
<p>但是，按理说第二个指标 - 每秒请求数也应该获得接近 12% 的提升。不过最后的变化却是 0%。究竟是出了什么问题呢？</p>
<p>他们最终定位到，是由于不同 Python 版本下的内存优化配置不同，导致 CPU 指令数下降带来的性能提升被抵消了。那为什么不同 Python 版本下的内存优化配置会不一样呢？</p>
<p>这是他们用来检查 uwsgi 配置的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">if uwsgi.opt.get(&#39;optimize_mem&#39;, None) == &#39;True&#39;:
    optimize_mem()
</code></pre></td></tr></table>
</div>
</div><p>注意到那段 <code>... ... == 'True'</code> 了吗？在 Python 3 中，这个条件判断总是不会被满足。问题就在于 unicode。在将代码中的 <code>'True'</code> 换成 <code>b'True'</code>（也就是将文本类型换成二进制，这种判断在 Python 2 中完全不区分的）后，问题解决了。</p>
<p><strong>所以，最终因为加上了一个小小的字母 &lsquo;b&rsquo;，程序的整体性能提升了 12%。</strong></p>
<h3 id="结论">结论</h3>
<p>在今年二月份，Instagram 的后端代码的运行环境完全切换到了 Python 3 下：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-15-51-20_thumb.jpg"
        data-srcset="http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-15-51-20_thumb.jpg, http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-15-51-20_thumb.jpg 1.5x, http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-15-51-20_thumb.jpg 2x"
        data-sizes="auto"
        alt="http://www.zlovezl.cn/static//uploaded/2017/05/2017-05-30-15-51-20_thumb.jpg"
        title="图：Instagram 版本迁移时间线" /></p>
<p>当所有的代码都都迁移到 Python 3 运行环境后：</p>
<ul>
<li>节约了 12% 的整体 CPU 使用率（Django/uwsgi）</li>
<li>节约了 30% 的内存使用（celery）</li>
</ul>
<p>同时，在整个迁移期间，Instagram 的月活用户经历了从 4 亿到 6亿 的巨大增长。产品也发布了评论过滤、直播等非常多新功能。</p>
<p>那么，那几个最开始驱动他们迁移到 Python 3 的目的呢？</p>
<ul>
<li><strong>类型注解</strong>：Instagram 的整个 codebase 里已经有 2% 的代码添加上了类型注解，同时他们还开发了一些工具来辅助开发者添加类型提示</li>
<li><strong>asyncio</strong>：他们在单个接口中利用 asynio 平行的去做多件事情，最终降低了 20-30% 的请求延迟。</li>
<li><strong>社区</strong>：他们与 Intel 的工程师联合，帮助他们更好的对 CPU 利用率进行调优。同时还开发了很多新的工具，帮助他们进行性能调优</li>
</ul>
<h2 id="instagram-带给我们的启示">Instagram 带给我们的启示</h2>
<p>Instagram 的演讲视频时间不长，但是内容很丰富，在编写此文前，我完全没有想到最终的文章会这么长。</p>
<p>那么，Instagram 的视频可以给我们哪些启示呢？</p>
<ul>
<li>Python + Django 的组合完全可以负载用户数以 10 亿记的服务，如果你正准备开始一个项目，放心使用 Python 吧！</li>
<li>完善的单元测试对于复杂项目是非常有必要的。如果没有那『成千上万的单元测试』。很难想象 Instagram 的迁移项目可以成功进行下去。</li>
<li>开发者和同事也是你的产品用户，利用好他们。用他们为你的新特性发布前多一道测试。</li>
<li>完全基于主分支的开发流程，可以给你更快的迭代速度。前提是拥有完善的单元测试和持续部署流程。</li>
<li>Python 3 是大势所趋，如果你正准备开始一个新项目，无需迟疑，拥抱 Python 3 吧！</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-07-21</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/instagram%E5%9C%A8pycon2017%E7%9A%84%E6%BC%94%E8%AE%B2%E6%91%98%E8%A6%81/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/python/">python</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/offer18-%E5%88%A0%E9%99%A4%E9%93%BE%E8%A1%A8%E7%9A%84%E8%8A%82%E7%82%B9/" class="prev" rel="prev" title="Offer18删除链表的节点"><i class="fas fa-angle-left fa-fw"></i>Offer18删除链表的节点</a>
            <a href="/141%E7%8E%AF%E5%BD%A2%E9%93%BE%E8%A1%A8/" class="next" rel="next" title="141环形链表">141环形链表<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/twemoji@13.0.0/dist/twemoji.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":16},"comment":{"valine":{"appId":"QGzwQXOqs5JOhN4RGPOkR2mR-MdYXbMMI","appKey":"WBmoGyJtbqUswvfLh6L8iEBr","avatar":"mp","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"你的评论 ...","recordIP":true,"serverURLs":"https://leancloud.hugoloveit.com","visitor":true}},"data":{"id-1":"affectalways","id-2":"affectalways"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
